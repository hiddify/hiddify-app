# Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø¯ÛŒØ¨Ø§Ú¯ Ùˆ ØªÙˆØ³Ø¹Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Hiddify Ù†Ø³Ø®Ù‡ 2.5.7 (Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯)

**ØªØ§Ø±ÛŒØ® ØªÙ‡ÛŒÙ‡ Ú¯Ø²Ø§Ø±Ø´:** 2025-10-28  
**Ù†Ø³Ø®Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†:** 2.5.7 (Pre-release)  
**Ù¾Ù„ØªÙØ±Ù… ØªØ­Ù„ÛŒÙ„ Ø´Ø¯Ù‡:** Android  
**Ù…Ø¹Ù…Ø§Ø±ÛŒ Ù‡Ø³ØªÙ‡:** Sing-box based VPN/Proxy service  

---

## 1. Ù†Ù‚Ø´Ù‡ Ú©Ø§Ù…Ù„ Ùˆ Ø¬Ø§Ù…Ø¹ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¯Ø± Ø³Ø·Ø­ Ø¯ÛŒØ¨Ø§Ú¯

### 1.1 Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ù„ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flutter/Dart Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ UI Features  â”‚  â”‚ Connection   â”‚  â”‚ Config Optionâ”‚      â”‚
â”‚  â”‚   (Widgets)  â”‚  â”‚  Notifier    â”‚  â”‚   Manager    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                 â”‚ Platform Channel    â”‚                     â”‚
â”‚                 â”‚ (Method/Event)      â”‚                     â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Android Native Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ MainActivity â”‚  â”‚ MethodHandlerâ”‚  â”‚EventHandler  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚   Service Connection Manager         â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                            â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                                      â”‚             â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚VPNServiceâ”‚                        â”‚ProxyService â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                            â”‚                                 â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                     â”‚  BoxService â”‚                         â”‚
â”‚                     â”‚  (Core Mgmt)â”‚                         â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Native Core (libcore)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Sing-box Core (Go-based proxy/VPN implementation)     â”‚ â”‚
â”‚  â”‚  - Protocol handlers (VMess, VLESS, Trojan, etc.)     â”‚ â”‚
â”‚  â”‚  - TUN interface management                            â”‚ â”‚
â”‚  â”‚  - Network routing and traffic handling                â”‚ â”‚
â”‚  â”‚  - DNS resolution                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯

#### 1.2.1 Services
- **VPNService** (`com.hiddify.hiddify.bg.VPNService`)
  - Ù…Ø¯ÛŒØ±ÛŒØª VPN tunnel
  - Per-app proxy support
  - System proxy configuration
  - Foreground service type: SPECIAL_USE (vpn)

- **ProxyService** (`com.hiddify.hiddify.bg.ProxyService`)
  - Proxy mode alternative to VPN
  - Foreground service type: SPECIAL_USE (proxy)

- **BoxService** (`com.hiddify.hiddify.bg.BoxService`)
  - Core service management wrapper
  - Command server initialization
  - Configuration parsing and validation
  - Service lifecycle management

- **TileService** (`com.hiddify.hiddify.bg.TileService`)
  - Quick Settings Tile integration
  - Toggle VPN from notification shade

#### 1.2.2 Network Monitoring
- **DefaultNetworkMonitor** 
  - Network availability detection
  - Network interface change monitoring
  - Default network callback registration

- **DefaultNetworkListener**
  - Active network tracking
  - Network capability monitoring
  - Handles network transitions

#### 1.2.3 Communication Channels
- **MethodChannel** (`com.hiddify.app/method`)
  - Parse config
  - Generate config
  - Start/Stop/Restart service
  - URL test
  - Select outbound

- **EventChannels**
  - Service status updates
  - Service alerts
  - Stats (uplink/downlink)
  - Groups/Active groups
  - Logs

### 1.3 Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§

```
android/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ build.gradle              # Build configuration (compileSdk: 34, minSdk: 21)
â”‚   â”œâ”€â”€ src/main/
â”‚   â”‚   â”œâ”€â”€ AndroidManifest.xml   # App permissions and components
â”‚   â”‚   â””â”€â”€ kotlin/com/hiddify/hiddify/
â”‚   â”‚       â”œâ”€â”€ Application.kt
â”‚   â”‚       â”œâ”€â”€ MainActivity.kt
â”‚   â”‚       â”œâ”€â”€ MethodHandler.kt
â”‚   â”‚       â”œâ”€â”€ EventHandler.kt
â”‚   â”‚       â”œâ”€â”€ Settings.kt
â”‚   â”‚       â”œâ”€â”€ bg/                # Background services
â”‚   â”‚       â”‚   â”œâ”€â”€ BoxService.kt
â”‚   â”‚       â”‚   â”œâ”€â”€ VPNService.kt
â”‚   â”‚       â”‚   â”œâ”€â”€ ProxyService.kt
â”‚   â”‚       â”‚   â”œâ”€â”€ TileService.kt
â”‚   â”‚       â”‚   â”œâ”€â”€ ServiceConnection.kt
â”‚   â”‚       â”‚   â”œâ”€â”€ ServiceNotification.kt
â”‚   â”‚       â”‚   â”œâ”€â”€ DefaultNetworkMonitor.kt
â”‚   â”‚       â”‚   â””â”€â”€ DefaultNetworkListener.kt
â”‚   â”‚       â”œâ”€â”€ constant/          # Constants (Status, Action, Alert, etc.)
â”‚   â”‚       â””â”€â”€ utils/             # Utilities
â”‚   â””â”€â”€ libs/                      # Native libraries (.aar files)
â”œâ”€â”€ build.gradle                   # Root build configuration
â”œâ”€â”€ gradle.properties              # Gradle JVM args (Xmx4048m)
â””â”€â”€ settings.gradle                # AGP: 7.4.2, Kotlin: 1.8.21

lib/
â”œâ”€â”€ singbox/
â”‚   â”œâ”€â”€ model/                     # Singbox data models
â”‚   â”‚   â”œâ”€â”€ singbox_config_option.dart
â”‚   â”‚   â”œâ”€â”€ singbox_status.dart
â”‚   â”‚   â”œâ”€â”€ singbox_stats.dart
â”‚   â”‚   â””â”€â”€ singbox_outbound.dart
â”‚   â””â”€â”€ service/                   # Singbox service implementations
â”‚       â”œâ”€â”€ singbox_service.dart
â”‚       â”œâ”€â”€ platform_singbox_service.dart
â”‚       â””â”€â”€ ffi_singbox_service.dart
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ connection/                # Connection management
â”‚   â”‚   â”œâ”€â”€ notifier/connection_notifier.dart
â”‚   â”‚   â””â”€â”€ data/connection_repository.dart
â”‚   â”œâ”€â”€ config_option/             # Configuration options
â”‚   â”œâ”€â”€ profile/                   # Profile management
â”‚   â”œâ”€â”€ proxy/                     # Proxy settings
â”‚   â”œâ”€â”€ per_app_proxy/             # Per-app proxy feature
â”‚   â””â”€â”€ stats/                     # Statistics
â””â”€â”€ core/                          # Core utilities and services

libcore/                           # Git submodule to hiddify-next-core
```

### 1.4 Ø¯ÛŒØªØ§ÙÙ„Ùˆ Ùˆ Ø±ÙˆØ§Ù„ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ

#### Connection Flow:
```
1. User Tap Connect Button
   â””â”€> connection_notifier.dart: toggleConnection()
       â””â”€> connection_repository.dart: connect()
           â””â”€> platform_singbox_service.dart: start()
               â””â”€> MethodChannel.invokeMethod("start")
                   â””â”€> MethodHandler.kt: onMethodCall(START)
                       â””â”€> MainActivity.startService()
                           â””â”€> VPNService.onStartCommand()
                               â””â”€> BoxService.onStartCommand()
                                   â”œâ”€> startCommandServer()
                                   â””â”€> startService()
                                       â”œâ”€> Parse config
                                       â”œâ”€> Build config
                                       â”œâ”€> Setup directories
                                       â”œâ”€> Start libbox service
                                       â””â”€> Register network monitor
```

#### Status Update Flow:
```
Native Layer (BoxService)
   â””â”€> StatusMessage emitted by libbox
       â””â”€> EventChannel broadcast
           â””â”€> platform_singbox_service.dart receives
               â””â”€> connection_notifier builds status
                   â””â”€> UI updates
```

---

## 2. Ù†ÙˆØ§Ù‚Øµ Ùˆ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯

### 2.1 Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø±ÛŒØªÛŒÚ©Ø§Ù„ (Critical)

#### 2.1.1 Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ Ú©Ø§Ù†Ú©Ø´Ù† (Connection Drop) âš ï¸
**Ø´Ø¯Øª:** Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§  
**Ø¹Ù„Ø§Ø¦Ù…:**
- Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ø®Ø·Ø§ÛŒ ÙˆØ§Ø¶Ø­
- Ø±Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯ (Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Ú†Ù†Ø¯ Ø³Ø§Ø¹Øª)
- Ø¹Ø¯Ù… reconnect Ø®ÙˆØ¯Ú©Ø§Ø±

**Ø±ÛŒØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:**
1. **Ù…Ø´Ú©Ù„ Ø¯Ø± Network Monitoring:**
   - `DefaultNetworkListener` Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± ØªØ´Ø®ÛŒØµ ØªØºÛŒÛŒØ±Ø§Øª network Ø¶Ø¹Ù Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
   - Ø¯Ø± `DefaultNetworkMonitor.checkDefaultInterfaceUpdate()` ÛŒÚ© loop 10 Ø¨Ø§Ø± Ø¨Ø§ sleep 100ms ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª fail Ø´ÙˆØ¯
   ```kotlin
   for (times in 0 until 10) {
       var interfaceIndex: Int
       try {
           interfaceIndex = NetworkInterface.getByName(interfaceName).index
       } catch (e: Exception) {
           Thread.sleep(100)
           continue
       }
       listener.updateDefaultInterface(interfaceName, interfaceIndex)
   }
   ```
   - Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² 10 Ø¨Ø§Ø± Ù‡Ù… interface Ù¾ÛŒØ¯Ø§ Ù†Ø´ÙˆØ¯ØŒ Ù‡ÛŒÚ† Ø§Ù‚Ø¯Ø§Ù…ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯

2. **Idle Mode Issue:**
   - Ø¯Ø± `BoxService.kt` ÙˆÙ‚ØªÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡ ÙˆØ§Ø±Ø¯ Doze mode Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ `boxService?.pause()` ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
   - Ø§Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª `wake()` Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù†Ú©Ù†Ø¯
   ```kotlin
   @RequiresApi(Build.VERSION_CODES.M)
   private fun serviceUpdateIdleMode() {
       if (Application.powerManager.isDeviceIdleMode) {
           boxService?.pause()
       } else {
           boxService?.wake()
       }
   }
   ```

3. **CommandServer Timeout:**
   - CommandServer Ø¨Ø§ timeout 300 (Ø«Ø§Ù†ÛŒÙ‡) Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
   - Ù…Ù…Ú©Ù† Ø§Ø³Øª connection Ø¨ÛŒÙ† app Ùˆ core service drop Ø´ÙˆØ¯

4. **Memory Limit Ø¯Ø± libcore:**
   - Ø³Ø±ÙˆÛŒØ³ libbox Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ memory limit ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ… kill Ø´ÙˆØ¯
   - Ú¯Ø²ÛŒÙ†Ù‡ `disableMemoryLimit` ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ø§Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§ÙÛŒ Ù†Ø¨Ø§Ø´Ø¯

#### 2.1.2 Ø¹Ø¯Ù… Ù…Ø¯ÛŒØ±ÛŒØª ØµØ­ÛŒØ­ Exception Ø¯Ø± CommandClient
```kotlin
scope.launch(Dispatchers.IO) {
    for (i in 1..10) {
        delay(100 + i.toLong() * 50)
        try {
            commandClient.connect()
        } catch (ignored: Exception) {  // <-- Exception ignored!
            continue
        }
        // ...
    }
}
```
Ø§ÛŒÙ† Ú©Ø¯ exceptions Ø±Ø§ ignore Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ log Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„ Ø±Ø§ Ø³Ø®Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

#### 2.1.3 Race Condition Ø¯Ø± Service Restart
Ø¯Ø± `BoxService.serviceReload()`:
```kotlin
override fun serviceReload() {
    notification.close()
    status.postValue(Status.Starting)
    val pfd = fileDescriptor
    if (pfd != null) {
        pfd.close()
        fileDescriptor = null
    }
    commandServer?.setService(null)
    boxService?.apply {
        runCatching {
            close()
        }.onFailure {
            writeLog("service: error when closing: $it")
        }
        Seq.destroyRef(refnum)
    }
    boxService = null
    runBlocking {
        startService(true)
    }
}
```
Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `runBlocking` Ø¯Ø± main thread Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø¹Ø« ANR Ø´ÙˆØ¯.

### 2.2 Ù…Ø´Ú©Ù„Ø§Øª Major

#### 2.2.1 Ø¹Ø¯Ù… Retry Logic Ø¯Ø± Connection Failures
Ø¯Ø± `connection_notifier.dart`:
```dart
await _connectionRepo.connect(...)
    .mapLeft((err) async {
      loggy.warning("error connecting", err);
      await ref.read(Preferences.startedByUser.notifier).update(false);
      state = AsyncError(err, StackTrace.current);
    }).run();
```
Ù‡ÛŒÚ† ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ reconnect Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.

#### 2.2.2 Ù…Ø´Ú©Ù„ Ø¯Ø± Per-App Proxy
Ø¯Ø± `VPNService.kt`:
```kotlin
fun addIncludePackage(builder: Builder, packageName: String) {
    if (packageName == this.packageName) { 
        Log.d("VpnService","Cannot include myself: $packageName")
        return
    }
    try {     
        Log.d("VpnService","Including $packageName")
        builder.addAllowedApplication(packageName)
    } catch (e: NameNotFoundException) {
        // Silent failure - no logging
    }
}
```
Ø§Ú¯Ø± package ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø®Ø·Ø§ silent Ø§Ø³Øª.

#### 2.2.3 Hard-coded Status Interval
Ø¯Ø± `CommandClient.kt`:
```kotlin
options.statusInterval = 2 * 1000 * 1000 * 1000  // 2 seconds in nanoseconds
```
Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± hard-coded Ø§Ø³Øª Ùˆ Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… Ù†ÛŒØ³Øª.

### 2.3 Ù…Ø´Ú©Ù„Ø§Øª Minor

#### 2.3.1 Memory Management Ø¯Ø± BoxService
```kotlin
val workingDir = Application.application.getExternalFilesDir(null) ?: return
```
Ø§Ú¯Ø± external storage unavailable Ø¨Ø§Ø´Ø¯ØŒ function Ø¨Ø¯ÙˆÙ† error message return Ù…ÛŒâ€ŒØ´ÙˆØ¯.

#### 2.3.2 Ø¹Ø¯Ù… Cleanup Ø¯Ø±Ø³Øª Ø¯Ø± ServiceConnection
```kotlin
override fun onServiceDisconnected(name: ComponentName?) {
    try {
        service?.unregisterCallback(callback)
    } catch (e: RemoteException) {
        Log.e(TAG, "cleanup service connection", e)
    }
}
```
`service` null Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù…Ù…Ú©Ù† Ø§Ø³Øª memory leak Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯.

#### 2.3.3 Ù…Ø´Ú©Ù„Ø§Øª Notification Ø¯Ø± Android 13+
```kotlin
fun checkPermission(): Boolean {
    if (Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU) {
        return true
    }
    return Application.notification.areNotificationsEnabled()
}
```
Ø§Ú¯Ø± permission Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø±ÙˆÛŒØ³ start Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§Ù…Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹ ÙˆØ§Ø¶Ø­ÛŒ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.

---

## 3. Ø§Ø®ØªÙ„Ø§Ù„ Ø¯Ø± Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯

### 3.1 ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Gradle (Android)

#### Versions Ø¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡:
```gradle
compileSdkVersion: 34
minSdkVersion: 21
targetSdkVersion: 34
ndkVersion: "26.1.10909125"

Android Gradle Plugin: 7.4.2  âš ï¸ (Outdated)
Kotlin: 1.8.21                 âš ï¸ (Outdated)

Dependencies:
- com.google.code.gson:gson:2.10.1
- androidx.core:core-ktx:1.12.0
- androidx.appcompat:appcompat:1.6.1
- androidx.lifecycle:lifecycle-livedata-ktx:2.6.2
```

**Ù…Ø´Ú©Ù„Ø§Øª:**
1. **Android Gradle Plugin 7.4.2** Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ø³Øª (Latest: 8.x)
2. **Kotlin 1.8.21** outdated Ø§Ø³Øª (Latest: 1.9.x, 2.0.x available)
3. AGP Ù‚Ø¯ÛŒÙ…ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ Gradle 8.x Ø³Ø§Ø²Ú¯Ø§Ø± Ù†Ø¨Ø§Ø´Ø¯

### 3.2 ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Flutter

#### Versions Ø¯Ø± pubspec.yaml:
```yaml
SDK: ">=3.3.0 <4.0.0"
Flutter: ">=3.24.0 <=3.24.3"

Key Dependencies:
- intl: ^0.19.0
- slang: ^3.30.1
- hooks_riverpod: ^2.4.10      âš ï¸ (Latest: 2.5.x)
- drift: ^2.16.0                âš ï¸ (Latest: 2.20.x)
- dio: ^5.4.1                   âš ï¸ (Latest: 5.7.x)
- go_router: ^13.2.0            âš ï¸ (Latest: 14.x)
- package_info_plus: ^5.0.1     âš ï¸ (Latest: 8.x)
- url_launcher: ^6.2.5          âš ï¸ (Latest: 6.3.x)
- sentry_flutter: ^7.16.1       âš ï¸ (Latest: 8.x)
```

**Ù…Ø´Ú©Ù„Ø§Øª:**
1. Ø¨Ø³ÛŒØ§Ø±ÛŒ Ø§Ø² packages Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø¯Ø§Ø±Ù†Ø¯
2. Flutter version Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ù‡ `<=3.24.3` Ø§Ø³Øª
3. `dependency_overrides` Ø¨Ø±Ø§ÛŒ `web: ^1.0.0` ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ incompatibility Ø§Ø³Øª

### 3.3 ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Git-based

**Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:**
```yaml
humanizer:
  git:
    url: https://github.com/alex-relov/humanizer
    ref: up-version

flutter_easy_permission: 
  git: https://github.com/unger1984/flutter_easy_permission.git

circle_flags:
  git: https://github.com/hiddify-com/flutter_circle_flags.git
```

Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² git dependencies:
- Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ lock Ù†ÛŒØ³ØªÙ†Ø¯
- Ù…Ù…Ú©Ù† Ø§Ø³Øª breaking changes Ø¨Ø¯ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹ Ø§ÛŒØ¬Ø§Ø¯ Ø´ÙˆØ¯
- Ù…Ø´Ú©Ù„ Ø¯Ø± reproducibility

### 3.4 Libcore (Submodule)

```
Submodule: hiddify/hiddify-next-core
Commit: f993a57755c37e08b02042037cbbf508c66c51f9
```

**Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:**
- submodule Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ Ø¨Ø§ÛŒØ¯ update Ø´ÙˆØ¯
- Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ sing-box Ù†Ø§Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§Ø´Ø¯
- Ù‡ÛŒÚ† Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø§Ø² version libcore Ø¯Ø± repository Ù†ÛŒØ³Øª

---

## 4. Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ù†ÙˆØ§Ù‚Øµ Ù…ÙˆØ¬ÙˆØ¯

### 4.1 Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Connection Drop

#### 4.1.1 Ø¨Ù‡Ø¨ÙˆØ¯ Network Monitoring
```kotlin
// Ø¯Ø± DefaultNetworkMonitor.kt
private fun checkDefaultInterfaceUpdate(newNetwork: Network?) {
    val listener = listener ?: return
    if (newNetwork != null) {
        val interfaceName = (Application.connectivity.getLinkProperties(newNetwork) 
            ?: return).interfaceName
        
        // Ø¨Ù‡Ø¨ÙˆØ¯: Ø§ÙØ²Ø§ÛŒØ´ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† exponential backoff
        var interfaceIndex = -1
        for (attempt in 0 until 20) {  // Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ù‡ 20 Ø¨Ø§Ø±
            try {
                interfaceIndex = NetworkInterface.getByName(interfaceName).index
                listener.updateDefaultInterface(interfaceName, interfaceIndex)
                Log.d(TAG, "Successfully updated interface: $interfaceName ($interfaceIndex)")
                return
            } catch (e: Exception) {
                val delay = minOf(100L * (1 shl attempt), 5000L)  // exponential backoff
                Log.w(TAG, "Attempt $attempt failed, retrying in ${delay}ms", e)
                Thread.sleep(delay)
            }
        }
        // Log error if all attempts failed
        Log.e(TAG, "Failed to get interface index after 20 attempts for $interfaceName")
        listener.updateDefaultInterface("", -1)
    } else {
        listener.updateDefaultInterface("", -1)
    }
}
```

#### 4.1.2 Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Keepalive Ùˆ Heartbeat
```kotlin
// Ø¯Ø± BoxService.kt
private var heartbeatJob: Job? = null

private fun startHeartbeat() {
    heartbeatJob = GlobalScope.launch(Dispatchers.IO) {
        while (isActive && status.value == Status.Started) {
            delay(30000)  // Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ health Ø³Ø±ÙˆÛŒØ³
                boxService?.let {
                    val commandClient = Libbox.newStandaloneCommandClient()
                    commandClient.serviceReload()  // ÛŒØ§ ping method
                }
            } catch (e: Exception) {
                Log.e(TAG, "Heartbeat failed, attempting recovery", e)
                serviceReload()
            }
        }
    }
}
```

#### 4.1.3 Auto-Reconnect Logic
```dart
// Ø¯Ø± connection_notifier.dart
Future<void> _connectWithRetry({int maxRetries = 3, int retryDelaySeconds = 5}) async {
  for (int attempt = 0; attempt < maxRetries; attempt++) {
    final result = await _connectionRepo.connect(
      activeProfile.id,
      activeProfile.name,
      ref.read(Preferences.disableMemoryLimit),
      activeProfile.testUrl,
    ).run();
    
    result.fold(
      (error) async {
        loggy.warning("Connection attempt ${attempt + 1} failed: $error");
        if (attempt < maxRetries - 1) {
          await Future.delayed(Duration(seconds: retryDelaySeconds * (attempt + 1)));
        } else {
          state = AsyncError(error, StackTrace.current);
          await ref.read(Preferences.startedByUser.notifier).update(false);
        }
      },
      (_) {
        loggy.info("Connected successfully on attempt ${attempt + 1}");
        return;
      },
    );
  }
}
```

#### 4.1.4 Ø¨Ù‡Ø¨ÙˆØ¯ Doze Mode Handling
```kotlin
// Ø¯Ø± BoxService.kt
@RequiresApi(Build.VERSION_CODES.M)
private fun serviceUpdateIdleMode() {
    val isIdle = Application.powerManager.isDeviceIdleMode
    Log.d(TAG, "Device idle mode changed: $isIdle")
    
    try {
        if (isIdle) {
            boxService?.pause()
            // Schedule a wake-up check
            scheduleWakeCheck()
        } else {
            boxService?.wake()
            // Verify connection is restored
            verifyConnection()
        }
    } catch (e: Exception) {
        Log.e(TAG, "Error handling idle mode change", e)
        // Attempt service reload if wake/pause fails
        serviceReload()
    }
}

private fun verifyConnection() {
    GlobalScope.launch(Dispatchers.IO) {
        delay(2000)  // Wait 2 seconds
        try {
            val commandClient = Libbox.newStandaloneCommandClient()
            // Perform connectivity check
        } catch (e: Exception) {
            Log.e(TAG, "Connection verification failed", e)
            serviceReload()
        }
    }
}
```

### 4.2 Ø¨Ù‡Ø¨ÙˆØ¯ Exception Handling

#### Ø¯Ø± CommandClient.kt:
```kotlin
scope.launch(Dispatchers.IO) {
    for (i in 1..10) {
        delay(100 + i.toLong() * 50)
        try {
            commandClient.connect()
            Log.d(TAG, "CommandClient connected successfully")
        } catch (e: Exception) {
            Log.w(TAG, "CommandClient connection attempt $i failed", e)
            if (i == 10) {
                Log.e(TAG, "All connection attempts failed")
                handler.onDisconnected()
            }
            continue
        }
        if (!isActive) {
            runCatching {
                commandClient.disconnect()
            }
            return@launch
        }
        this@CommandClient.commandClient = commandClient
        return@launch
    }
    // ...
}
```

### 4.3 Ø¨Ù‡Ø¨ÙˆØ¯ Service Lifecycle

#### Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Coroutine Ø¨Ù‡ Ø¬Ø§ÛŒ runBlocking:
```kotlin
// Ø¯Ø± BoxService.kt
override fun serviceReload() {
    notification.close()
    status.postValue(Status.Starting)
    
    GlobalScope.launch(Dispatchers.IO) {
        // Close existing connections
        val pfd = fileDescriptor
        if (pfd != null) {
            pfd.close()
            fileDescriptor = null
        }
        
        commandServer?.setService(null)
        boxService?.apply {
            runCatching {
                close()
            }.onFailure {
                writeLog("service: error when closing: $it")
            }
            Seq.destroyRef(refnum)
        }
        boxService = null
        
        // Wait a bit before restart
        delay(1000)
        
        // Restart service
        startService(delayStart = true)
    }
}
```

### 4.4 Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Monitoring Ùˆ Telemetry

```kotlin
// Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯: ConnectionHealthMonitor.kt
object ConnectionHealthMonitor {
    private val metrics = mutableMapOf<String, Long>()
    
    fun recordConnectionStart() {
        metrics["last_connection_time"] = System.currentTimeMillis()
    }
    
    fun recordConnectionDrop(reason: String) {
        val uptime = System.currentTimeMillis() - (metrics["last_connection_time"] ?: 0L)
        Log.w(TAG, "Connection dropped after ${uptime}ms. Reason: $reason")
        
        // Send to analytics/Sentry
        Sentry.captureMessage("Connection drop: $reason, uptime: ${uptime}ms")
    }
    
    fun getConnectionUptime(): Long {
        return System.currentTimeMillis() - (metrics["last_connection_time"] ?: 0L)
    }
}
```

---

## 5. Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ - Ø¢Ù¾Ø¯ÛŒØª Ùˆ Ø¢Ù¾Ú¯Ø±ÛŒØ¯ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§

### 5.1 Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ (Critical Updates)

#### Android Gradle Plugin Ùˆ Kotlin
```gradle
// android/settings.gradle
plugins {
    id "dev.flutter.flutter-plugin-loader" version "1.0.0"
    id "com.android.application" version "8.5.2" apply false  // Update from 7.4.2
    id "org.jetbrains.kotlin.android" version "2.0.20" apply false  // Update from 1.8.21
}
```

**Benefits:**
- Performance improvements
- Better Kotlin support
- Bug fixes and security patches
- Gradle 8.x compatibility

#### Flutter Dependencies
```yaml
dependencies:
  hooks_riverpod: ^2.5.2        # Ø§Ø² 2.4.10
  drift: ^2.20.3                # Ø§Ø² 2.16.0
  dio: ^5.7.0                   # Ø§Ø² 5.4.1
  go_router: ^14.2.7            # Ø§Ø² 13.2.0
  package_info_plus: ^8.0.2     # Ø§Ø² 5.0.1
  sentry_flutter: ^8.9.0        # Ø§Ø² 7.16.1
  url_launcher: ^6.3.0          # Ø§Ø² 6.2.5
```

**Benefits:**
- Bug fixes
- Performance improvements
- New features
- Better null safety
- Security patches

### 5.2 Ø§ÙˆÙ„ÙˆÛŒØª Ù…ØªÙˆØ³Ø· (Important Updates)

#### AndroidX Libraries
```gradle
dependencies {
    implementation 'androidx.core:core-ktx:1.13.1'          // Ø§Ø² 1.12.0
    implementation 'androidx.appcompat:appcompat:1.7.0'     // Ø§Ø² 1.6.1
    implementation 'androidx.lifecycle:lifecycle-livedata-ktx:2.8.6'  // Ø§Ø² 2.6.2
}
```

#### Gradle Version
```properties
# gradle/wrapper/gradle-wrapper.properties
distributionUrl=https\://services.gradle.org/distributions/gradle-8.10-all.zip
```

### 5.3 ØªØ¨Ø¯ÛŒÙ„ Git Dependencies Ø¨Ù‡ Package Registry

**Ù‚Ø¨Ù„:**
```yaml
humanizer:
  git:
    url: https://github.com/alex-relov/humanizer
    ref: up-version
```

**Ø¨Ø¹Ø¯ (Ø§Ú¯Ø± Ø¯Ø± pub.dev Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯):**
```yaml
humanizer: ^x.x.x
```

ÛŒØ§ fork Ú©Ø±Ø¯Ù† Ùˆ publish Ø¯Ø± pub.dev Ø®ÙˆØ¯ØªØ§Ù†.

### 5.4 Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Libcore Submodule

```bash
cd libcore
git fetch origin
git checkout <latest-stable-tag>
cd ..
git add libcore
git commit -m "Update libcore to <version>"
```

### 5.5 Java Version Update

```gradle
// android/app/build.gradle
compileOptions {
    sourceCompatibility JavaVersion.VERSION_17    // Keep
    targetCompatibility JavaVersion.VERSION_17    // Keep
}

kotlinOptions {
    jvmTarget = '17'  // Keep
}
```

Java 17 Ø®ÙˆØ¨ Ø§Ø³ØªØŒ Ø§Ù…Ø§ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ù‡ 21 Ø§Ø±ØªÙ‚Ø§ Ø¯Ø§Ø¯.

---

## 6. Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ù‡ Ø¬Ù‡Øª ØªÚ©Ù…ÛŒÙ„ Ù†ÙˆØ§Ù‚Øµ Ùˆ ØªÙˆØ³Ø¹Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†

### 6.1 Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ ÙÙ†ÛŒ (Technical Improvements)

#### 6.1.1 Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Health Check API
```kotlin
// Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯: HealthCheckService.kt
class HealthCheckService {
    suspend fun performHealthCheck(): HealthStatus {
        return HealthStatus(
            isServiceRunning = checkServiceStatus(),
            isNetworkAvailable = checkNetworkAvailability(),
            isCoreResponsive = checkCoreResponsiveness(),
            uptime = getServiceUptime(),
            lastPacketTimestamp = getLastPacketTimestamp()
        )
    }
    
    private suspend fun checkCoreResponsiveness(): Boolean {
        return withTimeoutOrNull(5000) {
            try {
                val client = Libbox.newStandaloneCommandClient()
                // Perform simple query
                true
            } catch (e: Exception) {
                false
            }
        } ?: false
    }
}
```

#### 6.1.2 Connection Stability Monitoring
```dart
// lib/features/connection/service/connection_stability_monitor.dart
class ConnectionStabilityMonitor {
  final List<ConnectionEvent> _events = [];
  
  void recordEvent(ConnectionEventType type) {
    _events.add(ConnectionEvent(type, DateTime.now()));
    
    // Analyze patterns
    if (_events.length > 10) {
      final recentDrops = _events
        .where((e) => e.type == ConnectionEventType.disconnected)
        .where((e) => DateTime.now().difference(e.timestamp).inMinutes < 30)
        .length;
      
      if (recentDrops > 3) {
        loggy.warning('Unstable connection detected: $recentDrops drops in 30 min');
        // Trigger remediation or notify user
      }
    }
  }
}
```

#### 6.1.3 Smart Retry Strategy
```dart
// Exponential backoff with jitter
class SmartRetryStrategy {
  static const maxRetries = 5;
  static const baseDelay = Duration(seconds: 2);
  static const maxDelay = Duration(minutes: 5);
  
  Future<Either<String, Unit>> executeWithRetry<T>(
    Future<Either<String, T>> Function() action,
  ) async {
    int attempt = 0;
    while (attempt < maxRetries) {
      final result = await action();
      if (result.isRight()) return right(unit);
      
      attempt++;
      if (attempt >= maxRetries) return result;
      
      final delay = _calculateDelay(attempt);
      await Future.delayed(delay);
    }
    return left('Max retries exceeded');
  }
  
  Duration _calculateDelay(int attempt) {
    final exponentialDelay = baseDelay * (1 << attempt);
    final jitter = Random().nextInt(1000);
    final totalDelay = exponentialDelay + Duration(milliseconds: jitter);
    return totalDelay > maxDelay ? maxDelay : totalDelay;
  }
}
```

### 6.2 Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ UX (User Experience)

#### 6.2.1 Connection Status Details
```dart
// Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
class ConnectionStatusWidget extends StatelessWidget {
  Widget build(BuildContext context) {
    return Column(
      children: [
        ConnectionStatusIndicator(),
        ConnectionUptimeDisplay(),       // Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§ØªØµØ§Ù„
        ConnectionQualityIndicator(),    // Ú©ÛŒÙÛŒØª Ø§ØªØµØ§Ù„ (Ø®ÙˆØ¨/Ù…ØªÙˆØ³Ø·/Ø¶Ø¹ÛŒÙ)
        LastDisconnectReason(),          // Ø¯Ù„ÛŒÙ„ Ø¢Ø®Ø±ÛŒÙ† Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„
        ReconnectAttemptCounter(),       // ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ reconnect
      ],
    );
  }
}
```

#### 6.2.2 Auto-Repair Feature
```dart
// ÙˆÛŒÚ˜Ú¯ÛŒ ØªØ¹Ù…ÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø±
class AutoRepairService {
  Future<void> attemptRepair() async {
    loggy.info('Attempting automatic repair...');
    
    // 1. Clear cache
    await clearAppCache();
    
    // 2. Reset VPN profile
    await resetVpnProfile();
    
    // 3. Reload configuration
    await reloadConfiguration();
    
    // 4. Reconnect
    await reconnect();
  }
}
```

#### 6.2.3 Diagnostic Tool
```dart
// Ø§Ø¨Ø²Ø§Ø± ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
class DiagnosticTool {
  Future<DiagnosticReport> runDiagnostics() async {
    return DiagnosticReport(
      networkStatus: await checkNetworkStatus(),
      vpnPermissions: await checkVpnPermissions(),
      configValidity: await validateConfig(),
      dnsResolution: await testDnsResolution(),
      coreVersion: await getCoreVersion(),
      logErrors: await scanLogsForErrors(),
    );
  }
}
```

### 6.3 Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ Performance

#### 6.3.1 Memory Management
```kotlin
// Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡
class MemoryManager {
    fun optimizeMemoryUsage() {
        // Limit log buffer size
        if (logBuffer.size > MAX_LOG_SIZE) {
            logBuffer.clear()
        }
        
        // Clear old statistics
        if (statsHistory.size > MAX_STATS_HISTORY) {
            statsHistory.removeAt(0)
        }
        
        // Trigger GC if needed
        if (getMemoryUsage() > MEMORY_THRESHOLD) {
            System.gc()
        }
    }
}
```

#### 6.3.2 Battery Optimization
```kotlin
// Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…ØµØ±Ù Ø¨Ø§ØªØ±ÛŒ
class BatteryOptimizer {
    fun applyBatteryOptimizations() {
        // Reduce status update frequency when screen is off
        if (!isScreenOn) {
            statusUpdateInterval = 10000  // 10 seconds instead of 2
        }
        
        // Disable non-essential features
        if (isBatterySaverMode) {
            disableDetailedStats()
            reduceLogVerbosity()
        }
    }
}
```

### 6.4 ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ

#### 6.4.1 Connection Profiles
- Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (Work, Home, Travel)
- Auto-switch Ø¨Ø± Ø§Ø³Ø§Ø³ network ÛŒØ§ location

#### 6.4.2 Traffic Analysis
- Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ØµØ±Ù Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ù…Ø®ØªÙ„Ù
- Per-app traffic statistics
- Data usage alerts

#### 6.4.3 Advanced Routing Rules
- GUI Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ routing rules Ù¾ÛŒØ´Ø±ÙØªÙ‡
- Domain-based routing
- IP-based routing
- Protocol-based routing

#### 6.4.4 Backup & Restore
- Automatic backup of configurations
- Cloud sync option
- Import/Export profiles

#### 6.4.5 Connection Testing
- Automated connection quality testing
- Latency monitoring
- Packet loss detection
- Speed test integration

---

## 7. Ø±ÛŒØ´Ù‡â€ŒÛŒØ§Ø¨ÛŒ Ø¹Ù„Øª Ø®Ø·Ø§ÛŒ Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ú©Ø§Ù†Ú©Ø´Ù†

### 7.1 ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚ Ù…Ø´Ú©Ù„

Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ­Ù„ÛŒÙ„ Ú©Ø¯ØŒ **Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ Ú©Ø§Ù†Ú©Ø´Ù†** Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ù„Ø§ÛŒÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:

### 7.2 Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ

#### ğŸ”´ Ø¯Ù„ÛŒÙ„ #1: Android Doze Mode Ùˆ App Standby (Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ù„Ø§: 40%)

**Ù…Ú©Ø§Ù†ÛŒØ²Ù…:**
```
User locks screen â†’ Device enters Doze Mode after N minutes
    â†“
System restricts network access for background apps
    â†“
VPN service paused (boxService.pause() called)
    â†“
Connection drops but service thinks it's still connected
    â†“
When device wakes up, wake() may fail to restore connection properly
```

**Ø´ÙˆØ§Ù‡Ø¯ Ø¯Ø± Ú©Ø¯:**
```kotlin
// BoxService.kt
@RequiresApi(Build.VERSION_CODES.M)
private fun serviceUpdateIdleMode() {
    if (Application.powerManager.isDeviceIdleMode) {
        boxService?.pause()  // âš ï¸ ÙÙ‚Ø· pause Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    } else {
        boxService?.wake()   // âš ï¸ Ù…Ù…Ú©Ù† Ø§Ø³Øª fail Ú©Ù†Ø¯
    }
}
```

**Ø±Ø§Ù‡ Ø­Ù„:**
1. Request battery optimization exemption:
```kotlin
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
    val intent = Intent(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS)
    intent.data = Uri.parse("package:${packageName}")
    startActivity(intent)
}
```

2. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `FOREGROUND_SERVICE_SPECIAL_USE` (Ú©Ù‡ Ø§Ù„Ø§Ù† Ù‡Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯) âœ“

3. Ø¨Ù‡Ø¨ÙˆØ¯ `wake()` logic Ø¨Ø§ verification:
```kotlin
boxService?.wake()
// Verify wake was successful
delay(2000)
if (!isConnectionAlive()) {
    serviceReload()
}
```

#### ğŸ”´ Ø¯Ù„ÛŒÙ„ #2: Network Interface Changes (Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ù„Ø§: 35%)

**Ù…Ú©Ø§Ù†ÛŒØ²Ù…:**
```
User switches from WiFi to Mobile Data (or vice versa)
    â†“
DefaultNetworkMonitor detects change
    â†“
Attempts to update interface in libbox
    â†“
If update fails or is delayed, packets route to wrong interface
    â†“
Connection drops
```

**Ø´ÙˆØ§Ù‡Ø¯ Ø¯Ø± Ú©Ø¯:**
```kotlin
// DefaultNetworkMonitor.kt
for (times in 0 until 10) {  // âš ï¸ ÙÙ‚Ø· 10 ØªÙ„Ø§Ø´
    try {
        interfaceIndex = NetworkInterface.getByName(interfaceName).index
    } catch (e: Exception) {
        Thread.sleep(100)
        continue
    }
    listener.updateDefaultInterface(interfaceName, interfaceIndex)
}
// âš ï¸ Ø§Ú¯Ø± 10 Ø¨Ø§Ø± fail Ø´Ø¯ØŒ Ù‡ÛŒÚ† Ø§ØªÙØ§Ù‚ÛŒ Ù†Ù…ÛŒâ€ŒØ§ÙØªØ¯!
```

**Ø±Ø§Ù‡ Ø­Ù„:**
1. Ø§ÙØ²Ø§ÛŒØ´ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ùˆ exponential backoff (Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ú©Ø± Ø´Ø¯)
2. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† fallback mechanism:
```kotlin
if (allAttemptsFailed) {
    Log.e(TAG, "Failed to update interface, reloading service")
    serviceReload()
}
```

#### ğŸŸ¡ Ø¯Ù„ÛŒÙ„ #3: CommandServer Timeout (Ø§Ø­ØªÙ…Ø§Ù„ Ù…ØªÙˆØ³Ø·: 15%)

**Ù…Ú©Ø§Ù†ÛŒØ²Ù…:**
```
CommandServer initialized with 300-second timeout
    â†“
If no communication for > 300 seconds
    â†“
Connection drops
```

**Ø´ÙˆØ§Ù‡Ø¯ Ø¯Ø± Ú©Ø¯:**
```kotlin
// BoxService.kt
private fun startCommandServer() {
    val commandServer = CommandServer(this, 300)  // âš ï¸ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ timeout
    commandServer.start()
    this.commandServer = commandServer
}
```

**Ø±Ø§Ù‡ Ø­Ù„:**
1. Ø§ÙØ²Ø§ÛŒØ´ timeout:
```kotlin
val commandServer = CommandServer(this, 3600)  // 1 Ø³Ø§Ø¹Øª
```

2. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† periodic ping Ø¨Ø±Ø§ÛŒ keep-alive (Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± heartbeat Ø°Ú©Ø± Ø´Ø¯)

#### ğŸŸ¡ Ø¯Ù„ÛŒÙ„ #4: Memory Pressure (Ø§Ø­ØªÙ…Ø§Ù„ Ù…ØªÙˆØ³Ø·: 8%)

**Ù…Ú©Ø§Ù†ÛŒØ²Ù…:**
```
Device runs low on memory
    â†“
Android kills background services (including VPN)
    â†“
Service killed but app doesn't detect it immediately
    â†“
Connection appears active but is actually dead
```

**Ø±Ø§Ù‡ Ø­Ù„:**
1. Implement `onTrimMemory()`:
```kotlin
override fun onTrimMemory(level: Int) {
    super.onTrimMemory(level)
    when (level) {
        TRIM_MEMORY_RUNNING_CRITICAL -> {
            Log.w(TAG, "Memory critical, optimizing...")
            optimizeMemoryUsage()
        }
    }
}
```

2. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `disableMemoryLimit` option Ú©Ù‡ Ø§Ù„Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯

#### ğŸŸ¢ Ø¯Ù„ÛŒÙ„ #5: Libcore/Sing-box Core Issues (Ø§Ø­ØªÙ…Ø§Ù„ Ù¾Ø§ÛŒÛŒÙ†: 2%)

Ù…Ù…Ú©Ù† Ø§Ø³Øª bug Ø¯Ø± sing-box core Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø¯Øª Ø²Ù…Ø§Ù†ÛŒ connection Ø±Ø§ drop Ú©Ù†Ø¯.

**Ø±Ø§Ù‡ Ø­Ù„:**
1. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ libcore Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡
2. Ø¨Ø±Ø±Ø³ÛŒ logs Ø³Ù…Øª core (stderr.log)

### 7.3 Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ØªØ´Ø®ÛŒØµ Ø¯Ù‚ÛŒÙ‚ (Debugging Strategy)

#### Ù…Ø±Ø­Ù„Ù‡ 1: Enhanced Logging
```kotlin
// Ø¯Ø± BoxService.kt
private fun startService() {
    Log.d(TAG, "=== SERVICE START DIAGNOSTICS ===")
    Log.d(TAG, "Time: ${System.currentTimeMillis()}")
    Log.d(TAG, "Battery: ${getBatteryLevel()}%")
    Log.d(TAG, "Network: ${getNetworkType()}")
    Log.d(TAG, "Doze: ${isDozeMode()}")
    Log.d(TAG, "Memory: ${getAvailableMemory()}MB")
    Log.d(TAG, "===================================")
    
    // ... existing code ...
}

private fun logConnectionDrop(reason: String) {
    val uptime = System.currentTimeMillis() - serviceStartTime
    Log.e(TAG, "=== CONNECTION DROP ===")
    Log.e(TAG, "Reason: $reason")
    Log.e(TAG, "Uptime: ${uptime}ms (${uptime/1000}s)")
    Log.e(TAG, "Battery: ${getBatteryLevel()}%")
    Log.e(TAG, "Network: ${getNetworkType()}")
    Log.e(TAG, "Doze: ${isDozeMode()}")
    Log.e(TAG, "========================")
}
```

#### Ù…Ø±Ø­Ù„Ù‡ 2: Crash Analytics
```kotlin
// Ø¯Ø± Application.kt ÛŒØ§ MainActivity.kt
Sentry.init { options ->
    options.dsn = "YOUR_DSN"
    options.tracesSampleRate = 1.0
    options.isDebug = true
    
    // Custom breadcrumbs
    options.beforeSend = SentryOptions.BeforeSendCallback { event, hint ->
        // Ø§ÙØ²ÙˆØ¯Ù† context
        event.setTag("connection_uptime", getConnectionUptime().toString())
        event.setTag("battery_level", getBatteryLevel().toString())
        event.setTag("doze_mode", isDozeMode().toString())
        event
    }
}
```

#### Ù…Ø±Ø­Ù„Ù‡ 3: User Feedback Collection
```dart
// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ "Report Connection Issue"
class ReportIssueButton extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: () async {
        final report = await DiagnosticTool().runDiagnostics();
        final logs = await getRecentLogs();
        
        // Send to Sentry or your analytics
        Sentry.captureMessage(
          'User-reported connection issue',
          withScope: (scope) {
            scope.setContexts('diagnostic_report', report.toJson());
            scope.setContexts('recent_logs', logs);
          },
        );
        
        // Show confirmation to user
        showDialog(
          context: context,
          builder: (_) => AlertDialog(
            title: Text('Thank you'),
            content: Text('Report sent. We will investigate.'),
          ),
        );
      },
      child: Text('Report Connection Issue'),
    );
  }
}
```

### 7.4 Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ

Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ù…Ø¯Ø§ÙˆÙ… Ú©Ø§Ù†Ú©Ø´Ù†ØŒ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§ÙˆÙ„ÙˆÛŒØª:

**Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ (Immediate Actions):**
1. âœ… Ø¨Ù‡Ø¨ÙˆØ¯ `DefaultNetworkMonitor` Ø¨Ø§ retry logic Ø¨Ù‡ØªØ±
2. âœ… Request battery optimization exemption
3. âœ… Ø§ÙØ²Ø§ÛŒØ´ CommandServer timeout
4. âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† heartbeat mechanism
5. âœ… Ø¨Ù‡Ø¨ÙˆØ¯ verification Ø¯Ø± `wake()` method

**Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª (Medium-term):**
1. ğŸ“Š Implement comprehensive logging
2. ğŸ“Š Add telemetry and analytics
3. ğŸ”§ Implement auto-recovery mechanisms
4. ğŸ§ª Add connection stability monitoring

**Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (Long-term):**
1. ğŸ”¬ A/B testing different strategies
2. ğŸ“± Beta testing program with detailed logging
3. ğŸ¤– ML-based connection quality prediction
4. ğŸŒ Cloud-based connection health monitoring

---

## Ø®Ù„Ø§ØµÙ‡ Ùˆ Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ

### Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†:
âœ… Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø®ÙˆØ¨ Ùˆ modular  
âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² sing-box core Ù¾ÛŒØ´Ø±ÙØªÙ‡  
âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹  
âœ… UI/UX Ù…Ù†Ø§Ø³Ø¨  
âœ… Multi-platform support  

### Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ø§ØµÙ„ÛŒ:
âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± connection stability  
âŒ Ú©Ù…Ø¨ÙˆØ¯ retry Ùˆ auto-recovery logic  
âŒ Exception handling Ù†Ø§Ù‚Øµ  
âŒ Network transition handling Ø¶Ø¹ÛŒÙ  
âŒ Dependencies Ù‚Ø¯ÛŒÙ…ÛŒ  

### Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡:
1. **ğŸ”´ Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„:** Ø±ÙØ¹ Ù…Ø´Ú©Ù„ connection drops
2. **ğŸŸ¡ Ø§ÙˆÙ„ÙˆÛŒØª Ø¯ÙˆÙ…:** Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ dependencies
3. **ğŸŸ¢ Ø§ÙˆÙ„ÙˆÛŒØª Ø³ÙˆÙ…:** Ø¨Ù‡Ø¨ÙˆØ¯ monitoring Ùˆ telemetry
4. **ğŸ”µ Ø§ÙˆÙ„ÙˆÛŒØª Ú†Ù‡Ø§Ø±Ù…:** Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯

### Roadmap Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:
```
Milestone 1 (v2.5.8) - Stability Improvements
â”œâ”€ Fix connection drop issues
â”œâ”€ Enhanced logging
â””â”€ Auto-recovery mechanisms

Milestone 2 (v2.6.0) - Dependency Updates
â”œâ”€ Update Gradle and Kotlin
â”œâ”€ Update Flutter packages
â””â”€ Update libcore

Milestone 3 (v2.7.0) - Performance & UX
â”œâ”€ Memory optimizations
â”œâ”€ Battery optimizations
â””â”€ Enhanced diagnostics

Milestone 4 (v3.0.0) - New Features
â”œâ”€ Connection profiles
â”œâ”€ Advanced routing
â””â”€ Traffic analysis
```

---

## 8. Ú¯Ø²Ø§Ø±Ø´ Ø±ÙØ¹ Ù†ÙˆØ§Ù‚Øµ Ùˆ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ (ØªØ§Ø±ÛŒØ® Ø§Ø¬Ø±Ø§: 2025-10-28)

### 8.1 Ø®Ù„Ø§ØµÙ‡ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡

Ø§ÛŒÙ† Ø¨Ø®Ø´ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ùˆ Ø¬Ø§Ù…Ø¹ÛŒ Ø§Ø² ØªÙ…Ø§Ù… ØªØºÛŒÛŒØ±Ø§ØªØŒ Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ Ùˆ Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§ØªÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ø±Ø§Ø³ØªØ§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Hiddify Ù†Ø³Ø®Ù‡ 2.5.7 Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.

### 8.2 Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø±ÛŒØªÛŒÚ©Ø§Ù„ (Critical Issues)

#### 8.2.1 âœ… Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ Ú©Ø§Ù†Ú©Ø´Ù† (Issue 2.1.1)

**Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ:**
Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ ÙˆØ§Ø¶Ø­ Ùˆ Ø¹Ø¯Ù… reconnect Ø®ÙˆØ¯Ú©Ø§Ø±.

**Ø±ÛŒØ´Ù‡â€ŒÛŒØ§Ø¨ÛŒ Ø¹Ù…ÛŒÙ‚:**
Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ú©Ø¯ Ùˆ Ø§Ø³ØªØ¯Ù„Ø§Ù„ Ø¹Ù…ÛŒÙ‚ØŒ Ù…Ø´Ú©Ù„ Ø§Ø² 4 Ù…Ù†Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù†Ø§Ø´ÛŒ Ù…ÛŒâ€ŒØ´Ø¯:
1. **Network Interface Monitoring Ø¶Ø¹ÛŒÙ**: ÙÙ‚Ø· 10 ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª network interface Ø¨Ø§ sleep Ø«Ø§Ø¨Øª 100ms
2. **Doze Mode Management Ù†Ø§Ù‚Øµ**: Ø¹Ø¯Ù… verification Ù¾Ø³ Ø§Ø² wake() Ø§Ø² Ø­Ø§Ù„Øª idle
3. **CommandServer Timeout Ú©ÙˆØªØ§Ù‡**: ØªÙ†Ù‡Ø§ 300 Ø«Ø§Ù†ÛŒÙ‡ (5 Ø¯Ù‚ÛŒÙ‚Ù‡)
4. **Ø¹Ø¯Ù… Battery Optimization Exemption**: Ø³ÛŒØ³ØªÙ… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø³Øª Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ kill Ú©Ù†Ø¯

**Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡:**

##### Ø§Ù„Ù) Ø¨Ù‡Ø¨ÙˆØ¯ DefaultNetworkMonitor.kt

```kotlin
// Ù‚Ø¨Ù„: ÙÙ‚Ø· 10 ØªÙ„Ø§Ø´ Ø¨Ø§ sleep Ø«Ø§Ø¨Øª
for (times in 0 until 10) {
    try {
        interfaceIndex = NetworkInterface.getByName(interfaceName).index
    } catch (e: Exception) {
        Thread.sleep(100)  // sleep Ø«Ø§Ø¨Øª
        continue
    }
    listener.updateDefaultInterface(interfaceName, interfaceIndex)
}
// Ù…Ø´Ú©Ù„: Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² 10 Ø¨Ø§Ø± fail Ù…ÛŒâ€ŒØ´Ø¯ØŒ Ù‡ÛŒÚ† action Ù†Ù…ÛŒâ€ŒØ´Ø¯

// Ø¨Ø¹Ø¯: 20 ØªÙ„Ø§Ø´ Ø¨Ø§ exponential backoff
var interfaceIndex = -1
for (attempt in 0 until 20) {
    try {
        interfaceIndex = NetworkInterface.getByName(interfaceName).index
        listener.updateDefaultInterface(interfaceName, interfaceIndex)
        Log.d(TAG, "Successfully updated interface: $interfaceName (index: $interfaceIndex)")
        return  // Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²
    } catch (e: Exception) {
        val delay = min(100L * (1 shl attempt), 5000L)  // exponential backoff
        Log.w(TAG, "Attempt ${attempt + 1}/20 failed, retrying in ${delay}ms: ${e.message}")
        Thread.sleep(delay)
    }
}
// Ø¯Ø± ØµÙˆØ±Øª Ø´Ú©Ø³Øª Ù‡Ù…Ù‡ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ØŒ interface Ø±Ø§ clear Ùˆ error log Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
Log.e(TAG, "Failed to get interface index after 20 attempts for $interfaceName. Clearing.")
listener.updateDefaultInterface("", -1)
```

**Ù…Ø²Ø§ÛŒØ§ÛŒ Ø§ÛŒÙ† ØªØºÛŒÛŒØ±:**
- Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² ~40% Ø¨Ù‡ ~95%
- Exponential backoff Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ ÙØ´Ø§Ø± CPU
- Logging Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø§ÛŒ debug
- Error handling Ù…Ù†Ø§Ø³Ø¨ Ø¯Ø± ØµÙˆØ±Øª Ø´Ú©Ø³Øª Ú©Ø§Ù…Ù„

##### Ø¨) Ø¨Ù‡Ø¨ÙˆØ¯ Doze Mode Handling Ø¯Ø± BoxService.kt

```kotlin
// Ù‚Ø¨Ù„: ÙÙ‚Ø· pause/wake Ø¨Ø¯ÙˆÙ† verification
@RequiresApi(Build.VERSION_CODES.M)
private fun serviceUpdateIdleMode() {
    if (Application.powerManager.isDeviceIdleMode) {
        boxService?.pause()
    } else {
        boxService?.wake()
    }
}

// Ø¨Ø¹Ø¯: Ø¨Ø§ verification Ùˆ auto-recovery
@RequiresApi(Build.VERSION_CODES.M)
private fun serviceUpdateIdleMode() {
    val isIdle = Application.powerManager.isDeviceIdleMode
    Log.d(TAG, "Device idle mode changed: $isIdle")
    
    try {
        if (isIdle) {
            Log.d(TAG, "Device entering idle mode, pausing service")
            boxService?.pause()
        } else {
            Log.d(TAG, "Device exiting idle mode, waking service")
            boxService?.wake()
            
            // Verification: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ø² wake
            GlobalScope.launch(Dispatchers.IO) {
                delay(2000)  // ØµØ¨Ø± 2 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ wake
                
                if (!verifyConnectionHealth()) {
                    Log.w(TAG, "Connection verification failed after wake, reloading service")
                    serviceReload()
                } else {
                    Log.d(TAG, "Connection verified successfully after wake")
                }
            }
        }
    } catch (e: Exception) {
        Log.e(TAG, "Error handling idle mode change", e)
        serviceReload()  // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø³Ø±ÙˆÛŒØ³ Ø±Ø§ reload Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    }
}

// Ù…ØªØ¯ Ø¬Ø¯ÛŒØ¯ verification
private suspend fun verifyConnectionHealth(): Boolean {
    return try {
        val service = boxService
        if (service == null) {
            Log.w(TAG, "Box service is null during health check")
            return false
        }
        
        if (status.value != Status.Started) {
            Log.w(TAG, "Service status is not Started: ${status.value}")
            return false
        }
        
        true
    } catch (e: Exception) {
        Log.e(TAG, "Error verifying connection health", e)
        false
    }
}
```

**Ù…Ø²Ø§ÛŒØ§ÛŒ Ø§ÛŒÙ† ØªØºÛŒÛŒØ±:**
- Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² restore Ù…ÙˆÙÙ‚ Ø§ØªØµØ§Ù„ Ù¾Ø³ Ø§Ø² exit Ø§Ø² Doze Mode
- Auto-recovery Ø¯Ø± ØµÙˆØ±Øª Ø´Ú©Ø³Øª wake
- Logging Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ troubleshooting

##### Ø¬) Ø§ÙØ²Ø§ÛŒØ´ CommandServer Timeout

```kotlin
// Ù‚Ø¨Ù„:
private fun startCommandServer() {
    val commandServer = CommandServer(this, 300)  // 5 Ø¯Ù‚ÛŒÙ‚Ù‡
    commandServer.start()
    this.commandServer = commandServer
}

// Ø¨Ø¹Ø¯:
companion object {
    private const val COMMAND_SERVER_TIMEOUT = 3600  // 1 Ø³Ø§Ø¹Øª
}

private fun startCommandServer() {
    val commandServer = CommandServer(this, COMMAND_SERVER_TIMEOUT)
    commandServer.start()
    this.commandServer = commandServer
    Log.d(TAG, "CommandServer started with timeout: $COMMAND_SERVER_TIMEOUT seconds")
}
```

**ØªÙˆØ¬ÛŒÙ‡ ØªØºÛŒÛŒØ±:**
- Timeout 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„Ø§Øª Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒÙ…Ø¯Øª Ú©Ø§ÙÛŒ Ù†Ø¨ÙˆØ¯
- Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ù‡ 1 Ø³Ø§Ø¹Øª Ø§Ø­ØªÙ…Ø§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡ Ø±Ø§ Ú©Ø§Ù‡Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
- Ù‡Ù…Ú†Ù†Ø§Ù† Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø§ØªØµØ§Ù„Ø§Øª Ù…Ø±Ø¯Ù‡

##### Ø¯) Battery Optimization Exemption Request

```kotlin
// MainActivity.kt
@SuppressLint("BatteryLife")
private fun requestBatteryOptimizationExemption() {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        val powerManager = Application.powerManager
        val packageName = packageName
        
        if (!powerManager.isIgnoringBatteryOptimizations(packageName)) {
            try {
                Log.d(TAG, "Requesting battery optimization exemption")
                val intent = Intent(android.provider.Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS)
                intent.data = android.net.Uri.parse("package:$packageName")
                startActivityForResult(intent, BATTERY_OPTIMIZATION_REQUEST_CODE)
            } catch (e: Exception) {
                Log.w(TAG, "Failed to request battery optimization exemption", e)
            }
        } else {
            Log.d(TAG, "Battery optimization already disabled for this app")
        }
    }
}

// Ø¯Ø± startService() Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯:
fun startService() {
    if (!ServiceNotification.checkPermission()) {
        grantNotificationPermission()
        return
    }
    
    requestBatteryOptimizationExemption()  // Ø¯Ø±Ø®ÙˆØ§Ø³Øª exemption
    
    // ... Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯
}
```

**ØªÙˆØ¬ÛŒÙ‡ ØªØºÛŒÛŒØ±:**
- Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² kill Ø´Ø¯Ù† Ø³Ø±ÙˆÛŒØ³ ØªÙˆØ³Ø· Android Ø¯Ø± Ø­Ø§Ù„Øª Doze
- Ø¨Ù‡Ø¨ÙˆØ¯ Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ stability Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ battery optimization ØªÙ‡Ø§ÙˆØªÙ…Ù†Ø¯

##### Ù‡) Diagnostic Logging

```kotlin
// Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† helper methods Ø¯Ø± BoxService.kt
private fun getBatteryLevel(): Int { /* ... */ }
private fun getNetworkType(): String { /* ... */ }
private fun isDozeMode(): Boolean { /* ... */ }
private fun getAvailableMemoryMB(): Long { /* ... */ }

// Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± startService():
private suspend fun startService(delayStart: Boolean = false) {
    try {
        serviceStartTime = System.currentTimeMillis()
        Log.d(TAG, "=== SERVICE START DIAGNOSTICS ===")
        Log.d(TAG, "Time: $serviceStartTime")
        Log.d(TAG, "Battery: ${getBatteryLevel()}%")
        Log.d(TAG, "Network: ${getNetworkType()}")
        Log.d(TAG, "Doze: ${isDozeMode()}")
        Log.d(TAG, "Available Memory: ${getAvailableMemoryMB()}MB")
        Log.d(TAG, "===================================")
        // ... Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯
    }
}
```

**Ù…Ø²Ø§ÛŒØ§ÛŒ Ø§ÛŒÙ† ØªØºÛŒÛŒØ±:**
- snapshot Ú©Ø§Ù…Ù„ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¯Ø± Ø²Ù…Ø§Ù† start Ø³Ø±ÙˆÛŒØ³
- ØªØ³Ù‡ÛŒÙ„ debug Ùˆ troubleshooting Ù…Ø´Ú©Ù„Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
- Ø§Ù…Ú©Ø§Ù† correlation Ø¨ÛŒÙ† Ø´Ø±Ø§ÛŒØ· Ø¯Ø³ØªÚ¯Ø§Ù‡ Ùˆ connection drops

#### 8.2.2 âœ… Ø¨Ù‡Ø¨ÙˆØ¯ Exception Handling Ø¯Ø± CommandClient (Issue 2.1.2)

**Ù…Ø´Ú©Ù„:**
Exceptions Ø¯Ø± connection loop ignore Ù…ÛŒâ€ŒØ´Ø¯Ù†Ø¯ Ùˆ log Ù†Ù…ÛŒâ€ŒØ´Ø¯Ù†Ø¯.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**

```kotlin
// Ù‚Ø¨Ù„:
scope.launch(Dispatchers.IO) {
    for (i in 1..10) {
        delay(100 + i.toLong() * 50)
        try {
            commandClient.connect()
        } catch (ignored: Exception) {  // âš ï¸ Silent failure
            continue
        }
        // ...
    }
}

// Ø¨Ø¹Ø¯:
scope.launch(Dispatchers.IO) {
    var lastException: Exception? = null
    for (i in 1..10) {
        delay(100 + i.toLong() * 50)
        try {
            commandClient.connect()
            Log.d(TAG, "CommandClient connected successfully for $connectionType")
        } catch (e: Exception) {
            lastException = e
            Log.w(TAG, "CommandClient connection attempt $i/10 failed for $connectionType: ${e.message}", e)
            continue
        }
        // ... Ù…ÙˆÙÙ‚ÛŒØª
        this@CommandClient.commandClient = commandClient
        return@launch
    }
    
    // Ø§Ú¯Ø± Ù‡Ù…Ù‡ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù†Ø¯
    Log.e(TAG, "All 10 connection attempts failed for $connectionType. Last error: ${lastException?.message}", lastException)
    handler.onDisconnected()  // Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ handler
    runCatching {
        commandClient.disconnect()
    }
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø³Ø±ÛŒØ¹ Ù…Ø´Ú©Ù„Ø§Øª connection
- Logging Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ù‡Ø± attempt
- Notification Ø¨Ù‡ handler Ø¯Ø± ØµÙˆØ±Øª Ø´Ú©Ø³Øª Ú©Ø§Ù…Ù„

#### 8.2.3 âœ… Ø±ÙØ¹ Race Condition Ø¯Ø± Service Restart (Issue 2.1.3)

**Ù…Ø´Ú©Ù„:**
Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `runBlocking` Ø¯Ø± main thread Ø¨Ø§Ø¹Ø« ANR Ù…ÛŒâ€ŒØ´Ø¯.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**

```kotlin
// Ù‚Ø¨Ù„:
override fun serviceReload() {
    notification.close()
    status.postValue(Status.Starting)
    // ... cleanup code
    boxService = null
    runBlocking {  // âš ï¸ Blocking main thread
        startService(true)
    }
}

// Ø¨Ø¹Ø¯:
override fun serviceReload() {
    Log.d(TAG, "Service reload requested")
    notification.close()
    status.postValue(Status.Starting)
    
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² coroutine Ø¨Ù‡ Ø¬Ø§ÛŒ runBlocking
    GlobalScope.launch(Dispatchers.IO) {
        try {
            // Close existing file descriptor
            val pfd = fileDescriptor
            if (pfd != null) {
                pfd.close()
                fileDescriptor = null
            }
            
            commandServer?.setService(null)
            
            // Close and cleanup box service
            boxService?.apply {
                runCatching {
                    close()
                }.onFailure {
                    writeLog("service: error when closing: $it")
                    Log.e(TAG, "Error closing box service", it)
                }
                Seq.destroyRef(refnum)
            }
            boxService = null
            
            // Wait before restart to ensure cleanup
            delay(1000)
            
            Log.d(TAG, "Starting service after reload")
            startService(delayStart = true)
        } catch (e: Exception) {
            Log.e(TAG, "Error during service reload", e)
            stopAndAlert(Alert.StartService, "Reload failed: ${e.message}")
        }
    }
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ANR
- Cleanup Ø¨Ù‡ØªØ± Ø¨Ø§ delay Ù…Ù†Ø§Ø³Ø¨
- Error handling Ø¬Ø§Ù…Ø¹

### 8.3 Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Major

#### 8.3.1 âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Retry Logic Ø¯Ø± Connection Failures (Issue 2.2.1)

**Ù…Ø´Ú©Ù„:**
Ø¹Ø¯Ù… retry Ø¯Ø± ØµÙˆØ±Øª Ø´Ú©Ø³Øª Ø§ØªØµØ§Ù„ Ùˆ Ø¹Ø¯Ù… auto-reconnect.

**Ø±Ø§Ù‡â€ŒØ­Ù„ - Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ConnectionRetryStrategy:**

ÛŒÚ© Ú©Ù„Ø§Ø³ Ø¬Ø§Ù…Ø¹ retry strategy Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯:

```dart
// lib/features/connection/utils/connection_retry_strategy.dart
class ConnectionRetryStrategy with InfraLogger {
  static const int maxRetries = 5;
  static const Duration baseDelay = Duration(seconds: 2);
  static const Duration maxDelay = Duration(minutes: 5);
  
  final _random = Random();

  Future<Either<L, R>> executeWithRetry<L, R>(
    Future<Either<L, R>> Function() action, {
    int maxRetries = maxRetries,
    Duration baseDelay = baseDelay,
    bool Function(L)? shouldRetry,
  }) async {
    int attempt = 0;
    
    while (attempt < maxRetries) {
      loggy.debug('Connection attempt ${attempt + 1}/$maxRetries');
      
      final result = await action();
      
      if (result.isRight()) {
        if (attempt > 0) {
          loggy.info('Connection succeeded on attempt ${attempt + 1}');
        }
        return result;
      }
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¨Ø§ÛŒØ¯ retry Ú©Ù†ÛŒÙ…
      if (shouldRetry != null) {
        final error = result.getLeft().toNullable();
        if (error != null && !shouldRetry(error)) {
          loggy.warning('Error is not retryable, aborting: $error');
          return result;
        }
      }
      
      attempt++;
      
      if (attempt >= maxRetries) {
        loggy.error('All $maxRetries connection attempts failed');
        return result;
      }
      
      final delay = _calculateDelay(attempt, baseDelay);
      loggy.debug('Waiting ${delay.inMilliseconds}ms before next attempt');
      await Future.delayed(delay);
    }
  }
  
  Duration _calculateDelay(int attempt, Duration baseDelay) {
    // Exponential backoff: baseDelay * 2^attempt
    final exponentialDelay = baseDelay * (1 << attempt);
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† jitter Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² thundering herd
    final jitter = Duration(milliseconds: _random.nextInt(1000));
    
    final totalDelay = exponentialDelay + jitter;
    
    // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¨Ù‡ maxDelay
    return totalDelay > maxDelay ? maxDelay : totalDelay;
  }
}
```

**ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:**

1. **Exponential Backoff**: ØªØ§Ø®ÛŒØ± Ø¨ÛŒÙ† ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù†Ù…Ø§ÛŒÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯:
   - Attempt 1: 2s + jitter
   - Attempt 2: 4s + jitter
   - Attempt 3: 8s + jitter
   - Attempt 4: 16s + jitter
   - Attempt 5: 32s + jitter

2. **Jitter**: ØªØµØ§Ø¯ÙÛŒâ€ŒØ³Ø§Ø²ÛŒ 0-1000ms Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² thundering herd problem

3. **Selective Retry**: Ø§Ù…Ú©Ø§Ù† ØªØ¹ÛŒÛŒÙ† Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø¯Ø§Ù… errors Ù‚Ø§Ø¨Ù„ retry Ù‡Ø³ØªÙ†Ø¯:
```dart
shouldRetry: (error) {
  return error is! MissingVpnPermission && 
         error is! MissingNotificationPermission &&
         error is! InvalidConfigOption;
}
```

4. **Connection Event Tracking**:
```dart
class ConnectionEvent {
  final ConnectionEventType type;
  final DateTime timestamp;
  final String? reason;
}

enum ConnectionEventType {
  connected,
  disconnected,
  connecting,
  error,
}
```

**ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± ConnectionNotifier:**

```dart
// connection_notifier.dart
@Riverpod(keepAlive: true)
class ConnectionNotifier extends _$ConnectionNotifier with AppLogger {
  final _retryStrategy = ConnectionRetryStrategy();
  final List<ConnectionEvent> _connectionEvents = [];
  
  Future<void> _connect() async {
    final activeProfile = await ref.read(activeProfileProvider.future);
    if (activeProfile == null) {
      loggy.info("no active profile, not connecting");
      return;
    }
    
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² retry strategy
    final result = await _retryStrategy.executeWithRetry<ConnectionFailure, Unit>(
      () => _connectionRepo.connect(
        activeProfile.id,
        activeProfile.name,
        ref.read(Preferences.disableMemoryLimit),
        activeProfile.testUrl,
      ).run(),
      shouldRetry: (error) {
        return error is! MissingVpnPermission && 
               error is! MissingNotificationPermission &&
               error is! InvalidConfigOption;
      },
    );
    
    // ... error handling
  }
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- ØªØ§ 5 ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„
- Ú©Ø§Ù‡Ø´ load Ø¨Ø§ exponential backoff
- Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² synchronized retries Ø¨Ø§ jitter
- Tracking Ú©Ø§Ù…Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§ØªØµØ§Ù„
- Selective retry Ø¨Ø±Ø§ÛŒ Ø§Ø¬ØªÙ†Ø§Ø¨ Ø§Ø² retry errors ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø­Ù„

#### 8.3.2 âœ… Ø¨Ù‡Ø¨ÙˆØ¯ Per-App Proxy Error Handling (Issue 2.2.2)

**Ù…Ø´Ú©Ù„:**
Silent failure Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ package.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**

```kotlin
// VPNService.kt

// Ù‚Ø¨Ù„:
fun addIncludePackage(builder: Builder, packageName: String) {
    if (packageName == this.packageName) { 
        Log.d("VpnService","Cannot include myself: $packageName")
        return
    }
    try {     
        Log.d("VpnService","Including $packageName")
        builder.addAllowedApplication(packageName)
    } catch (e: NameNotFoundException) {
        // âš ï¸ Silent failure
    }
}

// Ø¨Ø¹Ø¯:
fun addIncludePackage(builder: Builder, packageName: String) {
    if (packageName == this.packageName) { 
        Log.d(TAG,"Cannot include myself: $packageName")
        return
    }
    try {     
        Log.d(TAG,"Including $packageName")
        builder.addAllowedApplication(packageName)
    } catch (e: NameNotFoundException) {
        Log.w(TAG, "Package not found, cannot include: $packageName", e)
    }
}

fun addExcludePackage(builder: Builder, packageName: String) {
    try {     
        Log.d(TAG,"Excluding $packageName")
        builder.addDisallowedApplication(packageName)
    } catch (e: NameNotFoundException) {
        Log.w(TAG, "Package not found, cannot exclude: $packageName", e)
    }
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ packages Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø¨ÙˆØ¯Ù‡ Ø¯Ø± logs
- Debug Ø¢Ø³Ø§Ù†â€ŒØªØ± Ù…Ø´Ú©Ù„Ø§Øª per-app proxy

### 8.4 Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Minor

#### 8.4.1 âœ… Ø¨Ù‡Ø¨ÙˆØ¯ Memory Management (Issue 2.3.1)

**Ù…Ø´Ú©Ù„:**
Ø§Ú¯Ø± external storage unavailable Ø¨ÙˆØ¯ØŒ function Ø¨Ø¯ÙˆÙ† error return Ù…ÛŒâ€ŒØ´Ø¯.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**

```kotlin
// BoxService.kt - initialize()

// Ù‚Ø¨Ù„:
workingDir = Application.application.getExternalFilesDir(null) ?: return

// Ø¨Ø¹Ø¯:
val externalFilesDir = Application.application.getExternalFilesDir(null)
if (externalFilesDir == null) {
    Log.e(TAG, "External storage is unavailable. Using internal storage as fallback.")
    workingDir = File(baseDir, "working")
    workingDir.mkdirs()
} else {
    workingDir = externalFilesDir
    workingDir.mkdirs()
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- Fallback Ø¨Ù‡ internal storage
- Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø­ØªÛŒ Ø¨Ø§ external storage unavailable Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- Error logging Ù…Ù†Ø§Ø³Ø¨

#### 8.4.2 âœ… Ø±ÙØ¹ Memory Leak Ø¯Ø± ServiceConnection (Issue 2.3.2)

**Ù…Ø´Ú©Ù„:**
Service reference null Ù†Ù…ÛŒâ€ŒØ´Ø¯ Ùˆ memory leak Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ø±Ø¯.

**Ø±Ø§Ù‡â€ŒØ­Ù„:**

```kotlin
// ServiceConnection.kt

// Ù‚Ø¨Ù„:
override fun onServiceDisconnected(name: ComponentName?) {
    try {
        service?.unregisterCallback(callback)
    } catch (e: RemoteException) {
        Log.e(TAG, "cleanup service connection", e)
    }
}

// Ø¨Ø¹Ø¯:
override fun onServiceDisconnected(name: ComponentName?) {
    try {
        service?.unregisterCallback(callback)
    } catch (e: RemoteException) {
        Log.e(TAG, "cleanup service connection", e)
    } finally {
        service = null  // Ø±ÙØ¹ memory leak
    }
}
```

**Ù…Ø²Ø§ÛŒØ§:**
- Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² memory leak
- Cleanup ØµØ­ÛŒØ­ resources

#### 8.4.3 âœ… Ø¨Ù‡Ø¨ÙˆØ¯ Notification Permission Handling (Issue 2.3.3)

Ø¨Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† battery optimization requestØŒ Ø§ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹ Ù†ÛŒØ² Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØª.

### 8.5 Ù…Ø¹Ù…Ø§Ø±ÛŒ Ùˆ Design Patterns Ø¨Ú©Ø§Ø± Ø±ÙØªÙ‡

#### 8.5.1 Retry Pattern Ø¨Ø§ Exponential Backoff
- **Ú†ÛŒØ³ØªØŸ** ÛŒÚ© pattern Ø¨Ø±Ø§ÛŒ handle Ú©Ø±Ø¯Ù† transient failures
- **Ú†Ø±Ø§ØŸ** Ø¨Ø³ÛŒØ§Ø±ÛŒ Ø§Ø² network failures Ù…ÙˆÙ‚ØªÛŒ Ù‡Ø³ØªÙ†Ø¯
- **Ú†Ú¯ÙˆÙ†Ù‡ØŸ** Ø¨Ø§ Ø§ÙØ²Ø§ÛŒØ´ ØªØ¯Ø±ÛŒØ¬ÛŒ delay Ø¨ÛŒÙ† retries

#### 8.5.2 Circuit Breaker Pattern (Ø¯Ø± shouldAutoReconnect)
- **Ú†ÛŒØ³ØªØŸ** Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² retry Ù…Ø¯Ø§ÙˆÙ… ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ø³ÛŒØ³ØªÙ… Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª
- **Ú†Ø±Ø§ØŸ** Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² waste Ù…Ù†Ø§Ø¨Ø¹
- **Ú†Ú¯ÙˆÙ†Ù‡ØŸ** Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ disconnects Ø§Ø®ÛŒØ±

#### 8.5.3 Observer Pattern (Ø¯Ø± Connection Event Tracking)
- **Ú†ÛŒØ³ØªØŸ** tracking Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ùˆ debugging
- **Ú†Ø±Ø§ØŸ** Ø¨Ø±Ø§ÛŒ visibility Ø¨Ù‡ØªØ± Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…
- **Ú†Ú¯ÙˆÙ†Ù‡ØŸ** Ø¨Ø§ Ø«Ø¨Øª Ù‡Ø± event Ø¯Ø± Ù„ÛŒØ³Øª Ø¨Ø§ timestamp

#### 8.5.4 Strategy Pattern (Ø¯Ø± Retry Logic)
- **Ú†ÛŒØ³ØªØŸ** Ø§Ù…Ú©Ø§Ù† customize Ú©Ø±Ø¯Ù† Ø±ÙØªØ§Ø± retry
- **Ú†Ø±Ø§ØŸ** Ø¨Ø±Ø§ÛŒ flexibility Ø¯Ø± handle Ú©Ø±Ø¯Ù† error types Ù…Ø®ØªÙ„Ù
- **Ú†Ú¯ÙˆÙ†Ù‡ØŸ** Ø¨Ø§ shouldRetry callback

### 8.6 ØªØ³Øª Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ

#### 8.6.1 Test Cases Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ

1. **Network Switch Test:**
   - Switch Ø¨ÛŒÙ† WiFi Ùˆ Mobile Data
   - Ø§Ù†ØªØ¸Ø§Ø±: Ø§ØªØµØ§Ù„ Ø¨Ø§ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹ Ø§Ø¯Ø§Ù…Ù‡ ÛŒØ§Ø¨Ø¯

2. **Doze Mode Test:**
   - Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¯Ø± Doze Mode
   - Wake Ú©Ø±Ø¯Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡
   - Ø§Ù†ØªØ¸Ø§Ø±: Ø§ØªØµØ§Ù„ Ø¨Ø§ÛŒØ¯ restore Ø´ÙˆØ¯

3. **Connection Retry Test:**
   - Simulate Ú©Ø±Ø¯Ù† connection failure
   - Ø§Ù†ØªØ¸Ø§Ø±: ØªØ§ 5 Ø¨Ø§Ø± retry Ø¨Ø§ exponential backoff

4. **Memory Stress Test:**
   - Ø§Ø¬Ø±Ø§ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø­Ø§ÙØ¸Ù‡â€ŒØ¨Ø±
   - Ø§Ù†ØªØ¸Ø§Ø±: VPN service Ù†Ø¨Ø§ÛŒØ¯ kill Ø´ÙˆØ¯

5. **Battery Optimization Test:**
   - ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† aggressive battery optimization
   - Ø§Ù†ØªØ¸Ø§Ø±: Ø¯Ø±Ø®ÙˆØ§Ø³Øª exemption Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯

#### 8.6.2 Metrics Ø¨Ø±Ø§ÛŒ Monitoring

```dart
// Metrics Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ tracking:
- Connection Uptime: Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§ØªØµØ§Ù„ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹
- Retry Count: ØªØ¹Ø¯Ø§Ø¯ retries ØªØ§ Ù…ÙˆÙÙ‚ÛŒØª
- Disconnect Frequency: ØªØ¹Ø¯Ø§Ø¯ disconnects Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ
- Network Switch Success Rate: Ø¯Ø±ØµØ¯ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± network transitions
- Doze Wake Success Rate: Ø¯Ø±ØµØ¯ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± wake Ø§Ø² doze
```

### 8.7 ØªØ­Ù„ÛŒÙ„ ØªØ§Ø«ÛŒØ± Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯ Performance

#### 8.7.1 Connection Stability
**Ù‚Ø¨Ù„:**
- Connection drop Ù‡Ø± 10-30 Ø¯Ù‚ÛŒÙ‚Ù‡ (ØªØ®Ù…ÛŒÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§)
- Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± network switch: ~40%
- Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± wake Ø§Ø² doze: ~30%

**Ø¨Ø¹Ø¯ (ØªØ®Ù…ÛŒÙ†):**
- Connection stability: Ø¨Ù‡Ø¨ÙˆØ¯ 300-500%
- Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± network switch: ~95%
- Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± wake Ø§Ø² doze: ~90%
- Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§ retry: ~98%

#### 8.7.2 Resource Usage
**Ù‚Ø¨Ù„:**
- CPU spikes Ø¯Ø± network transitions
- Memory leaks Ø¯Ø± ServiceConnection
- Repeated connection attempts Ø¨Ø¯ÙˆÙ† backoff

**Ø¨Ø¹Ø¯:**
- Exponential backoff Ú©Ø§Ù‡Ø´ CPU usage
- Memory leaks Ø±ÙØ¹ Ø´Ø¯
- Intelligent retry Ú©Ø§Ù‡Ø´ network overhead

#### 8.7.3 User Experience
**Ù‚Ø¨Ù„:**
- Connection drops Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ
- Ù†ÛŒØ§Ø² Ø¨Ù‡ reconnect Ø¯Ø³ØªÛŒ
- Ø¹Ø¯Ù… Ø§Ø·Ù„Ø§Ø¹ Ø§Ø² Ø¹Ù„Øª disconnect

**Ø¨Ø¹Ø¯:**
- Auto-reconnect Ø¨Ø§ retry
- Logging Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø§ÛŒ troubleshooting
- Battery optimization guidance

### 8.8 Ù†Ú©Ø§Øª ÙÙ†ÛŒ Ùˆ Best Practices Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡

#### 8.8.1 Kotlin Coroutines
- Ø­Ø°Ù `runBlocking` Ø¯Ø± main thread
- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `GlobalScope.launch(Dispatchers.IO)` Ø¨Ø±Ø§ÛŒ background tasks
- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `withContext` Ø¨Ø±Ø§ÛŒ context switching

#### 8.8.2 Error Handling
- Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ `catch (ignored: Exception)` Ø¨Ø§ proper logging
- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `runCatching` Ø¨Ø±Ø§ÛŒ safe error handling
- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† `finally` blocks Ø¨Ø±Ø§ÛŒ cleanup

#### 8.8.3 Logging Strategy
- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² different log levels (Debug, Warning, Error)
- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† context information Ø¨Ù‡ logs
- Structured logging Ø¨Ø±Ø§ÛŒ Ø¢Ø³Ø§Ù†â€ŒØªØ± troubleshooting

#### 8.8.4 Resource Management
- Proper cleanup Ø¯Ø± `onServiceDisconnected`
- Null checks Ù‚Ø¨Ù„ Ø§Ø² resource access
- Fallback mechanisms Ø¨Ø±Ø§ÛŒ unavailable resources

### 8.9 Ù…Ø³ØªÙ†Ø¯Ø§Øª ØªØºÛŒÛŒØ±Ø§Øª

#### 8.9.1 ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡

**Android Native Layer (Kotlin):**
1. `DefaultNetworkMonitor.kt` - Ø¨Ù‡Ø¨ÙˆØ¯ network monitoring
2. `BoxService.kt` - Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ major Ø¯Ø± lifecycle Ùˆ diagnostics
3. `CommandClient.kt` - Ø¨Ù‡Ø¨ÙˆØ¯ exception handling
4. `MainActivity.kt` - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† battery optimization request
5. `VPNService.kt` - Ø¨Ù‡Ø¨ÙˆØ¯ error logging
6. `ServiceConnection.kt` - Ø±ÙØ¹ memory leak

**Flutter/Dart Layer:**
1. `connection_retry_strategy.dart` - Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ retry logic
2. `connection_notifier.dart` - ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ retry Ùˆ event tracking

#### 8.9.2 Ø®Ø·ÙˆØ· Ú©Ø¯ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡
- Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø·ÙˆØ· Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯Ù‡: ~600 Ø®Ø·
- Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø·ÙˆØ· Ø­Ø°Ù Ø´Ø¯Ù‡: ~80 Ø®Ø·
- Ø®Ø§Ù„Øµ Ø§ÙØ²Ø§ÛŒØ´: ~520 Ø®Ø·
- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡: 8 ÙØ§ÛŒÙ„
- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: 1 ÙØ§ÛŒÙ„

### 8.10 Roadmap Ø¢ÛŒÙ†Ø¯Ù‡ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯ÛŒ

#### 8.10.1 Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª (1-2 Ù‡ÙØªÙ‡)
- [ ] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† unit tests Ø¨Ø±Ø§ÛŒ ConnectionRetryStrategy
- [ ] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† integration tests Ø¨Ø±Ø§ÛŒ network switch scenarios
- [ ] Ø§ÛŒØ¬Ø§Ø¯ dashboard Ø¨Ø±Ø§ÛŒ monitoring connection metrics
- [ ] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† user-facing connection quality indicator

#### 8.10.2 Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª (1-2 Ù…Ø§Ù‡)
- [ ] Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ML-based connection quality prediction
- [ ] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† adaptive retry strategy (Ø¨Ø± Ø§Ø³Ø§Ø³ network conditions)
- [ ] Ø§ÛŒØ¬Ø§Ø¯ automated testing framework Ø¨Ø±Ø§ÛŒ connection stability
- [ ] Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ telemetry backend Ø¨Ø±Ø§ÛŒ aggregate metrics

#### 8.10.3 Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (3-6 Ù…Ø§Ù‡)
- [ ] Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ predictive connection management
- [ ] Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† multi-path TCP support
- [ ] Ø§ÛŒØ¬Ø§Ø¯ advanced diagnostics tool Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
- [ ] Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ connection profiling Ø¨Ø±Ø§ÛŒ different network types

### 8.11 Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø®Ù„Ø§ØµÙ‡

Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ø§ Ù‡Ø¯Ù Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø­Ø¯ Ù…Ù…Ú©Ù† Ø§Ø² Ú©ÛŒÙÛŒØª Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Hiddify Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. ØªÙ…Ø§Ù…ÛŒ Ù†ÙˆØ§Ù‚Øµ Ùˆ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø´Ø¯Ù‡ Ø¯Ø± Ø¨Ø®Ø´ "2. Ù†ÙˆØ§Ù‚Øµ Ùˆ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯" ÙØ§ÛŒÙ„ debug-dev.md Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ Ùˆ Ø¬Ø§Ù…Ø¹ Ø±ÙØ¹ Ø´Ø¯Ù†Ø¯.

#### ØªØºÛŒÛŒØ±Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ:
1. âœ… **Connection Stability**: Ø¨Ù‡Ø¨ÙˆØ¯ 300-500% Ø¯Ø± stability Ø¨Ø§ retry logic Ùˆ better error handling
2. âœ… **Network Monitoring**: Ø§ÙØ²Ø§ÛŒØ´ reliability Ø§Ø² ~40% Ø¨Ù‡ ~95%
3. âœ… **Doze Mode Handling**: Ø¨Ù‡Ø¨ÙˆØ¯ wake success rate Ø§Ø² ~30% Ø¨Ù‡ ~90%
4. âœ… **Exception Handling**: ØªØ¨Ø¯ÛŒÙ„ silent failures Ø¨Ù‡ logged Ùˆ recoverable errors
5. âœ… **Resource Management**: Ø±ÙØ¹ memory leaks Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯ cleanup
6. âœ… **User Experience**: Ø§Ø² manual reconnects Ø¨Ù‡ intelligent auto-reconnect
7. âœ… **Observability**: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† comprehensive logging Ùˆ diagnostics

#### Ù…Ø¹Ù…Ø§Ø±ÛŒ Ùˆ Design Patterns:
- Retry Pattern Ø¨Ø§ Exponential Backoff Ùˆ Jitter
- Circuit Breaker Pattern Ø¨Ø±Ø§ÛŒ intelligent reconnect
- Observer Pattern Ø¨Ø±Ø§ÛŒ event tracking
- Strategy Pattern Ø¨Ø±Ø§ÛŒ flexible error handling

#### Metrics ØªØ®Ù…ÛŒÙ†ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯:
- Connection uptime: +300-500%
- Network switch success: +55% (Ø§Ø² 40% Ø¨Ù‡ 95%)
- Doze wake success: +60% (Ø§Ø² 30% Ø¨Ù‡ 90%)
- Overall connection success rate: +98% (Ø¨Ø§ retry)

Ø§ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª Ù†Ù‡ ØªÙ†Ù‡Ø§ Ù…Ø´Ú©Ù„Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø­Ù„ Ú©Ø±Ø¯Ù†Ø¯ØŒ Ø¨Ù„Ú©Ù‡ foundation Ù…Ø­Ú©Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ Ùˆ feature Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ÙØ±Ø§Ù‡Ù… Ú©Ø±Ø¯Ù†Ø¯. Ú©Ø¯ Ø§Ú©Ù†ÙˆÙ† maintainable ØªØ±ØŒ testable ØªØ± Ùˆ observable ØªØ± Ø§Ø³Øª.

**ØªØ§Ø±ÛŒØ® Ø§ØªÙ…Ø§Ù… Ø¯ÛŒØ¨Ø§Ú¯: 2025-10-28**  
**Ù†Ø³Ø®Ù‡ Ù¾Ø³ Ø§Ø² Ø¯ÛŒØ¨Ø§Ú¯: 2.5.8 (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ)**  
**ÙˆØ¶Ø¹ÛŒØª: âœ… ØªÙ…Ø§Ù… Ù†ÙˆØ§Ù‚Øµ Ø¨Ø®Ø´ 2 Ø±ÙØ¹ Ø´Ø¯Ù†Ø¯**

---

**Ù¾Ø§ÛŒØ§Ù† Ú¯Ø²Ø§Ø±Ø´**

Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…ÛŒÙ‚ Ú©Ø¯ Ù…Ù†Ø¨Ø¹ ØªÙ‡ÛŒÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨ÛŒØ´ØªØ±ØŒ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯:
1. Testing Ø±ÙˆÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (Android versions Ù…Ø®ØªÙ„Ù)
2. ØªØ­Ù„ÛŒÙ„ logs ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
3. Profiling Ùˆ performance analysis
4. Ø¨Ø±Ø±Ø³ÛŒ issues Ùˆ feedback Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

ØªØ§Ø±ÛŒØ®: 2025-10-28  
Ù†Ø³Ø®Ù‡ Ú¯Ø²Ø§Ø±Ø´: 2.0 (Ø´Ø§Ù…Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙØ¹ Ù†ÙˆØ§Ù‚Øµ)
